name: orca

on:
  workflow_call:
    inputs:
      orca_ref:
        description: 'the name of the git ref variable in orca, e.g., REF_COATJAVA'
        required: true
        type: string
      pipeline_timeout:
        description: 'maximum time to allow orca pipeline to run (seconds)'
        required: false
        type: number
        default: 3600
    secrets:
      orca_project_id:
        description: 'orca gitlab project ID'
        required: true
      orca_project_token:
        description: 'project access token'
        required: true
      orca_trigger_token:
        description: 'pipeline trigger token'
        required: true

# apply cancel-in-progress to:
# - `pull_request` triggers from the same `head_ref` (PR feature branch) and caller repo (set by `repository_id`)
# - all other triggers: allow only the most recent of its trigger type (set by `event_name`, e.g., `push`) and caller repo
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.event_name }}-${{ github.repository_id }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  ORCA_ENDPOINT: https://code.jlab.org/api/v4/projects/${{ secrets.orca_project_id }}
  ORCA_PROJECT_TOKEN: ${{ secrets.orca_project_token }}
  ORCA_TRIGGER_TOKEN: ${{ secrets.orca_trigger_token }}
  SLEEP_INTERVAL: 60 # duration between each pipeline-status check [s]

jobs:

  orca_trigger:
    name: Trigger
    runs-on: ubuntu-latest
    outputs:
      pipeline_id: ${{ steps.trigger.outputs.pipeline_id }}
      pipeline_url: ${{ steps.trigger.outputs.web_url }}
    steps:
      - name: trigger orca pipeline
        id: trigger
        run: |
          response=$(curl \
            --silent --show-error --fail \
            --request POST \
            --form "token=$ORCA_TRIGGER_TOKEN" \
            --form "ref=main" \
            --form "variables[TRIGGERED_BY]=github" \
            --form "variables[GITHUB_EVENT]=${{ github.event_name }}" \
            --form "variables[GITHUB_REPO]=${{ github.repository }}" \
            --form "variables[GITHUB_SHA]=${{ github.sha }}" \
            --form "variables[GITHUB_RUN_ID]=${{ github.run_id }}" \
            --form "variables[${{ inputs.orca_ref }}]=${{ github.head_ref || github.ref_name }}" \
            "$ORCA_ENDPOINT/trigger/pipeline")
          echo "RESPONSE: $response"
          pipeline_id=$(echo $response | jq -r '.id')
          web_url=$(echo $response | jq -r '.web_url')
          if [ "$pipeline_id" == "null" ] || [ -z "$pipeline_id" ]; then
            echo "ERROR: Failed to trigger pipeline" >&2
            exit 1
          fi
          echo "pipeline_id=$pipeline_id" >> $GITHUB_OUTPUT
          echo "web_url=$web_url" >> $GITHUB_OUTPUT
          echo "Pipeline triggered successfully!"
          echo "Pipeline URL: $web_url"
          echo "Orca Pipeline URL: <$web_url>" >> $GITHUB_STEP_SUMMARY

  orca_wait:
    name: Wait
    runs-on: ubuntu-latest
    needs:
      - orca_trigger
    steps:
      - name: wait for orca pipeline
        run: |
          echo "Waiting for pipeline to complete ... checking every ${{ inputs.pipeline_timeout }} s ..."
          elapsed=0
          while [ $elapsed -lt ${{ inputs.pipeline_timeout }} ]; do
            response=$(curl \
              --silent --show-error --fail \
              --header "PRIVATE-TOKEN: $ORCA_PROJECT_TOKEN" \
              "$ORCA_ENDPOINT/pipelines/${{ needs.orca_trigger.outputs.pipeline_id }}")
            status=$(echo $response | jq -r '.status')
            echo "Current status: $status (elapsed: ${elapsed}s)"
            case $status in
              "success")
                echo "Pipeline completed successfully!"
                exit 0
                ;;
              "failed")
                echo "Pipeline failed!"
                exit 1
                ;;
              "canceled")
                echo "Pipeline was canceled!"
                exit 1
                ;;
              "skipped")
                echo "Pipeline was skipped!"
                exit 1
                ;;
              "running"|"pending"|"created")
                echo "Pipeline is still running..."
                sleep $SLEEP_INTERVAL
                elapsed=$((elapsed + SLEEP_INTERVAL))
                ;;
              *)
                echo "Unknown status: $status"
                sleep $SLEEP_INTERVAL
                elapsed=$((elapsed + SLEEP_INTERVAL))
                ;;
            esac
          done
          echo "Timeout waiting for pipeline to complete"
          exit 1
      - name: cancel pipeline if caller is cancelled
        if: cancelled() && needs.orca_trigger.outputs.pipeline_id
        run: |
          echo "GitHub workflow was cancelled, cancelling orca pipeline..."
          response=$(curl \
            --silent --show-error --fail \
            --write-out "\n%{http_code}" \
            --request POST \
            --header "PRIVATE-TOKEN: $ORCA_PROJECT_TOKEN" \
            "$ORCA_ENDPOINT/pipelines/${{ needs.orca_trigger.outputs.pipeline_id }}/cancel")
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | sed '$d')
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "GitLab pipeline cancelled successfully"
          else
            echo "Failed to cancel GitLab pipeline (HTTP $http_code)"
            echo "Response: $response_body"
            exit 1
          fi
